 <project name="Sensors" pubsub="auto" threads="1">
   <contqueries>
     <contquery name="CQ1">
       <windows>
         <window-source name="Data_Stream" index="pi_EMPTY" pubsub="true" insert-only="true" collapse-updates="true">
           <schema>
             <fields>
               <field name="id" type="string" key="true"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp"/>
               <field name="sound" type="double"/>
               <field name="light" type="double"/>
               <field name="distance" type="double"/>
               <field name="temperature" type="double"/>
               <field name="humidity" type="double"/>
             </fields>
           </schema>
         </window-source>
         <window-procedural name="Tag_transpose" index="pi_EMPTY" collapse-updates="true">
           <schema>
             <fields>
               <field name="id" type="string" key="true"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp"/>
               <field name="sound" type="double"/>
               <field name="light" type="double"/>
               <field name="distance" type="double"/>
               <field name="temperature" type="double"/>
               <field name="humidity" type="double"/>
               <field name="attribute" type="string" key="true"/>
               <field name="value" type="double"/>
             </fields>
           </schema>
           <ds2-code source="Data_Stream"><![CDATA[ds2_options cdump;
				 data esp.out;
				 dcl char(5) location;
				 dcl char(16) attribute;
				 dcl double value;
				 method run();
				 set esp.in;
				   attribute='sound';
				   value=sound;
				   output;
				   attribute='light';
				   value=light;
				   output;
				   attribute='distance';
				   value=distance;
				   output;
				   attribute='temperature';
				   value=temperature;
				   output;
				   attribute='humidity';
				   value=humidity;
				   output;
				 end;
				 enddata;]]></ds2-code>
         </window-procedural>
         <window-compute name="Keep_transpose_values" index="pi_EMPTY" collapse-updates="true">
           <schema>
             <fields>
               <field name="id" type="string"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp" key="true"/>
               <field name="attribute" type="string" key="true"/>
               <field name="value" type="double"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[id]]></field-expr>
             <field-expr><![CDATA[value]]></field-expr>
           </output>
         </window-compute>
         <window-copy name="Tag_forecast_window" index="pi_HASH" collapse-updates="true">
           <retention type="bycount_sliding">120 seconds</retention>
         </window-copy>
         <window-aggregate name="Tag_forecast" index="pi_HASH" collapse-updates="true">
           <schema>
             <fields>
               <field name="attribute" type="string" key="true"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp"/>
               <field name="forecast" type="double"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[ESP_aLast(timestamp)]]></field-expr>
             <field-expr><![CDATA[ESP_aAve(value)]]></field-expr>
           </output>
         </window-aggregate>
         <window-join name="Join_forecast" index="pi_EMPTY" collapse-updates="true">
           <join type="leftouter" no-regenerates="true">
             <conditions>
               <fields left="location" right="location"/>
               <fields left="attribute" right="attribute"/>
               <fields left="timestamp" right="timestamp"/>
             </conditions>
           </join>
           <output>
             <field-selection name="value" source="l_value"/>
             <field-selection name="forecast" source="r_forecast"/>
           </output>
         </window-join>
         <window-compute name="Calc_residual" index="pi_EMPTY" collapse-updates="true">
           <schema>
             <fields>
               <field name="attribute" type="string" key="true"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp" key="true"/>
               <field name="value" type="double"/>
               <field name="forecast" type="double"/>
               <field name="residual" type="double"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[value]]></field-expr>
             <field-expr><![CDATA[forecast]]></field-expr>
             <field-expr><![CDATA[value-forecast]]></field-expr>
           </output>
         </window-compute>
         <window-copy name="Tag_prev_residual_window" index="pi_HASH" collapse-updates="true">
           <retention type="bycount_sliding">120 seconds</retention>
         </window-copy>
         <window-aggregate name="Tag_prev_residual" index="pi_HASH" collapse-updates="true">
           <schema>
             <fields>
               <field name="attribute" type="string" key="true"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp"/>
               <field name="prevResidual" type="double"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[ESP_aLast(timestamp)]]></field-expr>
             <field-expr><![CDATA[ESP_aLag(residual,1)]]></field-expr>
           </output>
         </window-aggregate>
         <window-join name="Join_prev_residual" index="pi_EMPTY" collapse-updates="true">
           <join type="leftouter" no-regenerates="true">
             <conditions>
               <fields left="attribute" right="attribute"/>
               <fields left="location" right="location"/>
               <fields left="timestamp" right="timestamp"/>
             </conditions>
           </join>
           <output>
             <field-selection name="value" source="l_value"/>
             <field-selection name="forecast" source="l_forecast"/>
             <field-selection name="residual" source="l_residual"/>
             <field-selection name="prevResidual" source="r_prevResidual"/>
           </output>
         </window-join>
         <window-copy name="Tag_stddev_window" collapse-updates="true">
           <retention type="bycount_sliding">120 seconds</retention>
         </window-copy>
         <window-aggregate name="Tag_stddev" index="pi_HASH" collapse-updates="true">
           <schema>
             <fields>
               <field name="attribute" type="string" key="true"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp"/>
               <field name="stddev" type="double"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[ESP_aLast(timestamp)]]></field-expr>
             <field-expr><![CDATA[ESP_aStd(prevResidual)]]></field-expr>
           </output>
         </window-aggregate>
         <window-join name="Join_stddev" index="pi_EMPTY" collapse-updates="true">
           <join type="leftouter" no-regenerates="true">
             <conditions>
               <fields left="attribute" right="attribute"/>
               <fields left="location" right="location"/>
               <fields left="timestamp" right="timestamp"/>
             </conditions>
           </join>
           <output>
             <field-selection name="value" source="l_value"/>
             <field-selection name="forecast" source="l_forecast"/>
             <field-selection name="residual" source="l_residual"/>
             <field-selection name="stddev" source="r_stddev"/>
           </output>
         </window-join>
         <window-compute name="Tag_ctllim" index="pi_HASH" collapse-updates="true">
           <schema>
             <fields>
               <field name="attribute" type="string" key="true"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp" key="true"/>
               <field name="value" type="double"/>
               <field name="forecast" type="double"/>
               <field name="residual" type="double"/>
               <field name="stddev" type="double"/>
               <field name="uCtlLimit" type="double"/>
               <field name="lCtlLimit" type="double"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[value]]></field-expr>
             <field-expr><![CDATA[forecast]]></field-expr>
             <field-expr><![CDATA[residual]]></field-expr>
             <field-expr><![CDATA[stddev]]></field-expr>
             <field-expr><![CDATA[3*stddev]]></field-expr>
             <field-expr><![CDATA[0-3*stddev]]></field-expr>
           </output>
         </window-compute>
         <window-filter name="View_sound" collapse-updates="true">
           <expression><![CDATA[attribute=="sound           "]]></expression>
         </window-filter>
         <window-filter name="View_light" collapse-updates="true">
           <expression><![CDATA[attribute=="light           "]]></expression>
         </window-filter>
         <window-filter name="View_distance" collapse-updates="true">
           <expression><![CDATA[attribute=="distance        "]]></expression>
         </window-filter>
         <window-filter name="View_temperature" collapse-updates="true">
           <expression><![CDATA[attribute=="temperature     "]]></expression>
         </window-filter>
         <window-filter name="View_humidity" collapse-updates="true">
           <expression><![CDATA[attribute=="humidity        "]]></expression>
         </window-filter>
         <window-filter name="View_sound_PI105" collapse-updates="true">
           <expression><![CDATA[attribute=="sound           " and location=="pi105"]]></expression>
         </window-filter>
         <window-filter name="View_light_PI105" collapse-updates="true">
           <expression><![CDATA[attribute=="light           " and location=="pi105"]]></expression>
         </window-filter>
         <window-filter name="View_distance_PI105" collapse-updates="true">
           <expression><![CDATA[attribute=="distance        " and location=="pi105"]]></expression>
         </window-filter>
         <window-filter name="View_sound_PI107" collapse-updates="true">
           <expression><![CDATA[attribute=="sound           " and location=="pi107"]]></expression>
         </window-filter>
         <window-filter name="View_light_PI107" collapse-updates="true">
           <expression><![CDATA[attribute=="light           " and location=="pi107"]]></expression>
         </window-filter>
         <window-filter name="View_distance_PI107" collapse-updates="true">
           <expression><![CDATA[attribute=="distance        " and location=="pi107"]]></expression>
         </window-filter>
         <window-filter name="Signals" collapse-updates="true">
           <expression><![CDATA[residual>uCtlLimit or residual<lCtlLimit]]></expression>
         </window-filter>
         <window-compute name="Signal_key" collapse-updates="true">
           <schema>
             <fields>
               <field name="attribute" type="string" key="true"/>
               <field name="location" type="string" key="true"/>
               <field name="timestamp" type="stamp" key="true"/>
               <field name="signalKey" type="int32"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[1]]></field-expr>
           </output>
         </window-compute>
         <window-aggregate name="Signal_range" collapse-updates="true">
           <schema>
             <fields>
               <field name="signalKey" type="int32" key="true"/>
               <field name="beginTimestamp" type="stamp"/>
               <field name="currentTimestamp" type="stamp"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[ESP_aMin(timestamp)]]></field-expr>
             <field-expr><![CDATA[ESP_aMax(timestamp)]]></field-expr>
           </output>
         </window-aggregate>
         <window-aggregate name="Signal_range_lag" collapse-updates="true">
           <schema>
             <fields>
               <field name="signalKey" type="int32" key="true"/>
               <field name="beginTimestamp" type="stamp"/>
               <field name="currentTimestamp" type="stamp"/>
               <field name="signalCount" type="int32"/>
             </fields>
           </schema>
           <output>
             <field-expr><![CDATA[ESP_aLag(timestamp,5)]]></field-expr>
             <field-expr><![CDATA[ESP_aLast(timestamp)]]></field-expr>
             <field-expr><![CDATA[ESP_aCount()]]></field-expr>
           </output>
         </window-aggregate>
         <window-filter name="Events" collapse-updates="true">
           <expression><![CDATA[currentTimestamp-beginTimestamp>0
                                and currentTimestamp-beginTimestamp<0.25]]></expression>
         </window-filter>
         <window-copy name="Recent_event_window" index="pi_HASH" collapse-updates="true">
           <retention type="bycount_sliding">10 seconds</retention>
         </window-copy>
         <window-copy name="Set_recent_events" index="pi_HASH" collapse-updates="true">
           <retention type="bycount_sliding">120 seconds</retention>
         </window-copy>
         <window-procedural name="keep_signals" index="pi_EMPTY" output-insert-only="false" collapse-updates="true">
           <schema>
             <fields>
               <field name="signalKey" type="int32" key="true"/>
               <field name="beginTimestamp" type="stamp"/>
               <field name="currentTimestamp" type="stamp"/>
               <field name="signalCount" type="int32"/>
             </fields>
           </schema>
           <ds2-code source="Events"><![CDATA[ds2_options cdump;
data esp.out;
   dcl integer id; 
   dcl timestamp prevstartts ;
   retain id 0;
   retain prevstartts;
method run();
set esp.in;
if _opcode = 3  then return;	
if beginTimestamp=prevstartts then do;
       signalKey=id;
       _opcode=2;
end;
else do;
       id=id+1;
       signalKey=id;
       if _opcode = 2 then _opcode = 1;
end;
prevstartts=beginTimestamp;
		   
end;
enddata;]]></ds2-code>
         </window-procedural>
       </windows>
       <edges>
         <edge source="Data_Stream" target="Tag_transpose"/>
         <edge source="Tag_transpose" target="Keep_transpose_values"/>
         <edge source="Keep_transpose_values" target="Tag_forecast_window"/>
         <edge source="Tag_forecast_window" target="Tag_forecast"/>
         <edge source="Join_forecast" target="Calc_residual"/>
         <edge source="Calc_residual" target="Join_prev_residual"/>
         <edge source="Tag_prev_residual" target="Join_prev_residual"/>
         <edge source="Join_prev_residual" target="Tag_stddev_window"/>
         <edge source="Tag_stddev_window" target="Tag_stddev"/>
         <edge source="Calc_residual" target="Tag_prev_residual_window"/>
         <edge source="Tag_prev_residual_window" target="Tag_prev_residual"/>
         <edge source="Calc_residual" target="Join_stddev"/>
         <edge source="Tag_stddev" target="Join_stddev"/>
         <edge source="Tag_ctllim" target="View_sound"/>
         <edge source="Tag_ctllim" target="View_light"/>
         <edge source="Tag_ctllim" target="View_distance"/>
         <edge source="Tag_ctllim" target="View_temperature"/>
         <edge source="Tag_ctllim" target="View_humidity"/>
         <edge source="Tag_ctllim" target="Signals"/>
         <edge source="Tag_ctllim" target="View_sound_PI105"/>
         <edge source="Tag_ctllim" target="View_light_PI105"/>
         <edge source="Tag_ctllim" target="View_distance_PI105"/>
         <edge source="Tag_ctllim" target="View_sound_PI107"/>
         <edge source="Tag_ctllim" target="View_light_PI107"/>
         <edge source="Tag_ctllim" target="View_distance_PI107"/>
         <edge source="Signals" target="Signal_key"/>
         <edge source="Signal_key" target="Signal_range"/>
         <edge source="Signal_key" target="Signal_range_lag"/>
         <edge source="Signal_range_lag" target="Events"/>
         <edge source="Keep_transpose_values" target="Join_forecast"/>
         <edge source="Tag_forecast" target="Join_forecast"/>
         <edge source="Join_stddev" target="Set_recent_events"/>
         <edge source="Set_recent_events" target="Tag_ctllim"/>
         <edge source="Events" target="keep_signals"/>
         <edge source="keep_signals" target="Recent_event_window"/>
       </edges>
     </contquery>
   </contqueries>
 </project>